<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HOD Dashboard - CMR Gate Pass</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
      }

      .header {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .container {
        display: flex;
        min-height: calc(100vh - 70px);
      }

      .sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 20px 0;
      }

      .sidebar ul {
        list-style: none;
      }

      .sidebar li {
        padding: 15px 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .sidebar li:hover,
      .sidebar li.active {
        background-color: #34495e;
      }

      .main-content {
        flex: 1;
        padding: 20px;
      }

      .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .card h2 {
        color: #2c3e50;
        margin-bottom: 15px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      table,
      th,
      td {
        border: 1px solid #ddd;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      .priority-high {
        background-color: #ffebee;
        color: #e53935;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .priority-medium {
        background-color: #fff8e1;
        color: #ffa000;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .priority-low {
        background-color: #e8f5e9;
        color: #43a047;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
      }

      .btn-approve {
        background-color: #4caf50;
        color: white;
      }

      .btn-deny {
        background-color: #f44336;
        color: white;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
      }

      .stat-card h3 {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .stat-card .number {
        font-size: 28px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>CMR Gate Pass - HOD Dashboard</h1>
      <div class="user-info">
        <img
          src="/photos/{{ session.get('username') }}.jpg"
          alt="User Photo"
          onerror="this.style.display = 'none'"
        />
        <div>
          <div>{{ session.get('name', 'Faculty Member') }}</div>
          <div style="font-size: 12px">{{ session.get('username') }}</div>
        </div>
        <a href="/logout" style="color: white; margin-left: 15px">Logout</a>
      </div>
    </div>

    <div class="container">
      <div class="sidebar">
        <ul>
          <li class="active" onclick="showSection('faculty-pending')">
            Faculty Requests
          </li>
          <li onclick="showSection('approved')">Approved Today</li>
          <li onclick="showSection('denied')">Denied Today</li>
          <li onclick="showSection('monthly-report')">Monthly Report</li>
          <li onclick="showSection('faculty-list')">Total Faculty</li>
        </ul>
      </div>

      <div class="main-content">
        <!-- Faculty Pending Requests -->
        <div class="card" id="faculty-pending" style="display: block">
          <h2>Pending Faculty Leave Requests</h2>
          <table>
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Reason</th>
                <th>Priority</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for req in faculty_pending %}
              <tr>
                <td>{{ req.student_id }}</td>
                <td>{{ req.name }}</td>
                <td>{{ req.reason }}</td>
                <td>
                  <span class="priority-{{ req.priority }}"
                    >{{ req.priority }}</span
                  >
                </td>
                <td>{{ req.datetime }}</td>
                <td>
                  <form method="POST" action="/hod" style="display: inline">
                    <input
                      type="hidden"
                      name="request_id"
                      value="{{ req._id }}"
                    />
                    <button class="btn btn-approve" name="action" value="allow">
                      Approve
                    </button>
                  </form>
                  <form method="POST" action="/hod" style="display: inline">
                    <input
                      type="hidden"
                      name="request_id"
                      value="{{ req._id }}"
                    />
                    <button class="btn btn-deny" name="action" value="deny">
                      Deny
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" style="text-align: center">
                  No pending faculty requests
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Stats Summary -->
        <div class="stats">
          <div class="stat-card">
            <h3>Faculty Requests</h3>
            <div class="number">{{ faculty_pending|length }}</div>
          </div>
          <div class="stat-card">
            <h3>Approved Today</h3>
            <div class="number">{{ faculty_approved|length }}</div>
          </div>
          <div class="stat-card">
            <h3>Denied Today</h3>
            <div class="number">{{ faculty_denied|length }}</div>
          </div>
        </div>

        <!-- Approved Requests -->
        <div class="card" id="approved" style="display: none">
          <h2>Approved Today</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Reason</th>
                <th>QR Generated At</th>
                <th>Checkout Time</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody>
              {% for req in faculty_approved %}
              <tr>
                <td>{{ req.student_id }}</td>
                <td>{{ req.name }}</td>
                <td>{{ req.reason }}</td>
                <td>{{ req.check_in_time }}</td>
                <td>{{ req.checkout_time_display }}</td>
                <td>{{ req.duration_display }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" style="text-align: center">
                  No approved faculty requests
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Denied Requests -->
        <div class="card" id="denied" style="display: none">
          <h2>Denied Today</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Reason</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for req in faculty_denied %}
              <tr>
                <td>{{ req.student_id }}</td>
                <td>{{ req.name }}</td>
                <td>{{ req.reason }}</td>
                <td>{{ req.datetime }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" style="text-align: center">
                  No denied faculty requests
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Monthly Report -->
        <div class="card" id="monthly-report" style="display: none">
          <h2>Monthly Approved Requests Report</h2>
          <div
            style="
              margin-bottom: 20px;
              display: flex;
              gap: 10px;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <label for="month-select" style="font-weight: 600"
              >Select Month:</label
            >
            <select
              id="month-select"
              style="padding: 8px; border: 1px solid #ddd; border-radius: 4px"
            >
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <label for="year-select" style="font-weight: 600">Year:</label>
            <select
              id="year-select"
              style="padding: 8px; border: 1px solid #ddd; border-radius: 4px"
            >
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026" selected>2026</option>
              <option value="2027">2027</option>
            </select>
            <button
              onclick="filterByMonth()"
              class="btn btn-approve"
              style="padding: 8px 16px"
            >
              Filter
            </button>
          </div>
          <div
            id="monthly-summary"
            style="
              margin-bottom: 20px;
              padding: 15px;
              background-color: #f8f9fa;
              border-radius: 5px;
            "
          >
            <strong>Total Approved Requests: </strong
            ><span id="monthly-count">0</span>
          </div>
          <table>
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Reason</th>
                <th>Priority</th>
                <th>Request Date</th>
                <th>QR Generated At</th>
                <th>Scanned At</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody id="monthly-tbody">
              <tr>
                <td colspan="8" style="text-align: center">
                  Select a month and click Filter to view report
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Faculty List -->
        <div class="card" id="faculty-list" style="display: none">
          <h2>Total Faculty</h2>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Employee ID</th>
                <th>Faculty Name</th>
              </tr>
            </thead>
            <tbody>
              {% for fac in total_faculty %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ fac.emp_id }}</td>
                <td>{{ fac.name }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" style="text-align: center">No faculty found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // Store all approved requests for client-side filtering
      const allApprovedRequests = {{ faculty_approved_all|tojson }};

      function filterByMonth() {
          const month = document.getElementById('month-select').value;
          const year = document.getElementById('year-select').value;
          const tbody = document.getElementById('monthly-tbody');

          // Filter requests by selected month and year
          const filtered = allApprovedRequests.filter(req => {
              if (!req.generated_at) return false;

              // Parse the generated_at ISO timestamp
              const genDate = new Date(req.generated_at);
              const reqMonth = String(genDate.getMonth() + 1).padStart(2, '0');
              const reqYear = String(genDate.getFullYear());

              return reqMonth === month && reqYear === year;
          });

          // Update count
          document.getElementById('monthly-count').textContent = filtered.length;

          // Build table rows
          if (filtered.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No approved requests found for this month</td></tr>';
          } else {
              tbody.innerHTML = filtered.map(req => `
                  <tr>
                      <td>${req.student_id}</td>
                      <td>${req.name}</td>
                      <td>${req.reason}</td>
                      <td><span class="priority-${req.priority}">${req.priority}</span></td>
                      <td>${req.datetime}</td>
                      <td>${req.check_in_time || 'N/A'}</td>
                      <td>${req.checkout_time_display || 'Not Scanned'}</td>
                      <td>${req.duration_display || 'N/A'}</td>
                  </tr>
              `).join('');
          }
      }

      // Set current month and year on page load
      window.addEventListener('DOMContentLoaded', function() {
          const now = new Date();
          const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
          const currentYear = String(now.getFullYear());

          document.getElementById('month-select').value = currentMonth;
          document.getElementById('year-select').value = currentYear;
      });

      function showSection(sectionId) {
          // Hide all sections
          document.querySelectorAll('.main-content .card').forEach(card => {
              card.style.display = 'none';
          });

          // Show selected section
          document.getElementById(sectionId).style.display = 'block';

          // Update active menu item
          document.querySelectorAll('.sidebar li').forEach(item => {
              item.classList.remove('active');
          });
          event.target.classList.add('active');
      }

      // Function to update pending requests table
      function updatePendingTable(requests) {
          const tbody = document.querySelector('#faculty-pending tbody');
          if (requests.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending faculty requests</td></tr>';
              return;
          }

          tbody.innerHTML = requests.map(req => `
              <tr>
                  <td>${req.student_id || ''}</td>
                  <td>${req.name || ''}</td>
                  <td>${req.reason || ''}</td>
                  <td><span class="priority-${req.priority || 'low'}">${req.priority || 'low'}</span></td>
                  <td>${req.datetime || ''}</td>
                  <td>
                      <form method="POST" action="/hod" style="display:inline;">
                          <input type="hidden" name="request_id" value="${req._id}">
                          <button class="btn btn-approve" name="action" value="allow">Approve</button>
                      </form>
                      <form method="POST" action="/hod" style="display:inline;">
                          <input type="hidden" name="request_id" value="${req._id}">
                          <button class="btn btn-deny" name="action" value="deny">Deny</button>
                      </form>
                  </td>
              </tr>
          `).join('');
      }

      // Function to update approved requests table
      function updateApprovedTable(requests) {
          const tbody = document.querySelector('#approved tbody');
          if (requests.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No approved faculty requests</td></tr>';
              return;
          }

          tbody.innerHTML = requests.map(req => `
              <tr>
                  <td>${req.student_id || ''}</td>
                  <td>${req.name || ''}</td>
                  <td>${req.reason || ''}</td>
                  <td>${req.check_in_time || 'N/A'}</td>
                  <td>${req.checkout_time_display || 'Not Scanned'}</td>
                  <td>${req.duration_display || 'N/A'}</td>
              </tr>
          `).join('');
      }

      // Function to update denied requests table
      function updateDeniedTable(requests) {
          const tbody = document.querySelector('#denied tbody');
          if (requests.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No denied faculty requests</td></tr>';
              return;
          }

          tbody.innerHTML = requests.map(req => `
              <tr>
                  <td>${req.student_id || ''}</td>
                  <td>${req.name || ''}</td>
                  <td>${req.reason || ''}</td>
                  <td>${req.datetime || ''}</td>
              </tr>
          `).join('');
      }

      // Auto-refresh data every 5 seconds without page reload
      function refreshData() {
          fetch('/api/faculty/requests')
              .then(response => response.json())
              .then(data => {
                  // Update stat cards
                  document.querySelectorAll('.stat-card .number')[0].textContent = data.faculty_pending.length;
                  document.querySelectorAll('.stat-card .number')[1].textContent = data.faculty_approved.length;
                  document.querySelectorAll('.stat-card .number')[2].textContent = data.faculty_denied.length;

                  // Update tables
                  updatePendingTable(data.faculty_pending);
                  updateApprovedTable(data.faculty_approved);
                  updateDeniedTable(data.faculty_denied);
              })
              .catch(error => console.error('Error fetching updates:', error));
      }

      // Refresh immediately on page load and then every 5 seconds
      refreshData();
      setInterval(refreshData, 5000);
    </script>
  </body>
</html>
